<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="../static/css/styles.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Student Dashboard</title>
    <style>
      .session-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }
      .validation-warning {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        color: #856404;
      }
      .error-message {
        background-color: #f8d7da;
        border-left: 4px solid #dc3545;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        color: #721c24;
        display: none;
      }
      .success-message {
        background-color: #d4edda;
        border-left: 4px solid #28a745;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        color: #155724;
        display: none;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <!-- Thông tin session -->
      <div class="session-info" id="sessionInfo">
        <span> Đang tải thông tin...</span>
      </div>

      <!-- Cảnh báo validation -->
      <div class="validation-warning">
        <strong> Bảo mật điểm danh:</strong>
        <p>
          • Hệ thống chỉ cho phép điểm danh bằng khuôn mặt của chính sinh viên
          đã đăng nhập
        </p>
        <p>• Mọi hành vi gian lận sẽ được ghi lại và báo cáo</p>
        <p>• Vui lòng đảm bảo chính bạn thực hiện điểm danh</p>
      </div>

      <!-- Hiển thị thành công -->
      <div id="successMessage" class="success-message"></div>

      <!-- Hiển thị lỗi validation -->
      <div id="validationError" class="error-message"></div>
    </div>
    <header class="header_sd">
      <div style="width: 100%">
        <div class="header-left">
          <h1 id="studentName">Tên Sinh Viên</h1>
          <h2 id="MSSV">Mã số sinh viên</h2>
        </div>
        <div class="header-right">
          <button style="float: right" id="logout-button">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              viewBox="0 0 24 24"
              class="logout-icon"
            >
              <path
                fill="white"
                d="M10 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h5v-2H5V5h5V3zm4.59 4.41L13.17 9H20v2h-6.83l1.42 1.59L14 14l-4-4 4-4 1.59 1.41z"
              />
            </svg>
          </button>
        </div>
      </div>
    </header>

    <div class="container">
      <div style="width: 100%" class="main-content">
        <div class="schedule-container">
          <h2 class="title_sd"><b>Lịch học, lịch thi theo tuần</b></h2>
          <div class="options">
            <button class="btn_sd">< Trở về</button>
            <input type="date" class="date-input" />
            <button class="btn_sd">Tiếp ></button>
          </div>
          <table class="schedule-table">
            <thead>
              <tr class="tr_sd">
                <th>Ca học</th>
                <th>Thứ 2<br /></th>
                <th>Thứ 3<br /></th>
                <th>Thứ 4<br /></th>
                <th>Thứ 5<br /></th>
                <th>Thứ 6<br /></th>
                <th>Thứ 7<br /></th>
                <th>Chủ nhật<br /></th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td class="td_ca"><b>Sáng</b></td>
                <td>
                  <div class="class-box">
                    <div>
                      <strong>Phân tích và thiết kế thuật giải</strong><br />
                      23DHTT01 - 010100085401<br />
                      Tiết: 1 - 4<br />
                      Giờ: 07:00 - 10:35<br />
                      Phòng: G601<br />
                      GV: Nguyễn Thị Ngọc Thanh
                    </div>
                    <div class="icon-camera" onclick="openCamera(this)">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        fill="none"
                        viewBox="0 0 24 24"
                        stroke-width="1.5"
                        stroke="currentColor"
                        class="size-6"
                      >
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z"
                        />
                        <path
                          stroke-linecap="round"
                          stroke-linejoin="round"
                          d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z"
                        />
                      </svg>
                    </div>
                  </div>
                </td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td class="td_ca"><b>Chiều</b></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
              <tr>
                <td class="td_ca"><b>Tối</b></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
                <td></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <footer>
      <p>&copy; 2024 Hệ Thống Điểm Danh</p>
      <link href="../stactic/js/scripts.js" />
    </footer>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <script>
      // KIỂM TRA SESSION KHI TRANG LOAD
      window.onload = function () {
        checkSession();

        // Xác thực GPS sau khi kiểm tra session
        setTimeout(verifyGPSLocation, 1000);
      };

      function checkSession() {
        fetch("/check_session")
          .then((response) => response.json())
          .then((data) => {
            const sessionInfo = document.getElementById("sessionInfo");

            if (data.logged_in) {
              sessionInfo.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <strong> Đã đăng nhập:</strong> ${data.student_name} (${data.student_id})
                <br><small> Chỉ khuôn mặt của bạn mới được điểm danh</small>
            </div>
            <button class="logout-btn" onclick="logoutValidation()" style="background-color: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">Đăng xuất</button>
        </div>
        <div style="margin-top: 10px;">
            <button id="refreshLocationBtn" style="background-color: #17a2b8; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;">
                Cập nhật vị trí GPS
            </button>
        </div>
    `;

              // Gắn sự kiện cho nút làm mới vị trí
              setTimeout(() => {
                const refreshBtn =
                  document.getElementById("refreshLocationBtn");
                if (refreshBtn) {
                  refreshBtn.addEventListener("click", function () {
                    verifyGPSLocation();

                    // Kích hoạt lại các nút nếu xác thực thành công
                    if (gpsVerified) {
                      const cameraButtons =
                        document.querySelectorAll(".icon-camera");
                      cameraButtons.forEach((button) => {
                        button.style.opacity = "1";
                        button.style.cursor = "pointer";

                        // Khôi phục onclick ban đầu nếu đã lưu
                        if (button.dataset.originalOnclick) {
                          button.setAttribute(
                            "onclick",
                            button.dataset.originalOnclick
                          );
                        }
                      });
                    }
                  });
                }
              }, 500);

              // CẬP NHẬT THÔNG TIN HEADER
              document.getElementById("studentName").innerText =
                data.student_name;
              document.getElementById("MSSV").innerText = data.student_id;

              // LƯU VÀO sessionStorage
              sessionStorage.setItem(
                "studentInfo",
                JSON.stringify({
                  student_id: data.student_id,
                  name: data.student_name,
                })
              );
            } else {
              alert("Vui lòng đăng nhập trước khi sử dụng!");
              window.location.href = "/login_student";
            }
          })
          .catch((error) => {
            console.error("Lỗi kiểm tra session:", error);
            alert("Lỗi kết nối. Vui lòng thử lại!");
          });
      }

      // Thêm biến toàn cục để theo dõi trạng thái xác thực GPS
      let gpsVerified = false;
      // Hàm xác thực vị trí GPS
      function verifyGPSLocation() {
        // Hiển thị thông báo đang xác thực vị trí
        const sessionInfo = document.getElementById("sessionInfo");
        if (sessionInfo) {
          sessionInfo.innerHTML += `
            <div id="locationStatus" style="margin-top: 10px; padding: 8px; background-color: #fff3cd; border-radius: 4px;">
                <strong>Đang xác thực vị trí...</strong>
            </div>
        `;
        }

        if (!navigator.geolocation) {
          updateLocationStatus(
            false,
            "Trình duyệt của bạn không hỗ trợ định vị GPS."
          );
          return;
        }

        navigator.geolocation.getCurrentPosition(
          // Callback thành công
          function (position) {
            // Thêm một số phát hiện giả mạo cơ bản
            const coords = position.coords;

            // Nếu accuracy > 100, nghĩa là định vị không chính xác, sai số quá lớn (có thể đang dùng GPS ảo hoặc trình giả lập).
            if (coords.accuracy > 100) {
              updateLocationStatus(
                false,
                "Độ chính xác GPS quá thấp. Vui lòng đảm bảo GPS hoạt động đúng cách."
              );
              disableAttendanceButtons();
              return;
            }

            // Kiểm tra tốc độ di chuyển không thể có nếu có tọa độ trước đó
            if (window.lastPosition) {
              const timeDiff =
                (position.timestamp - window.lastPosition.timestamp) / 1000; // giây
              const distance = calculateClientDistance(
                coords.latitude,
                coords.longitude,
                window.lastPosition.coords.latitude,
                window.lastPosition.coords.longitude
              );
              const speed = distance / timeDiff; // mét/giây

              // Nếu tốc độ > 100 m/s (~360 km/h), có thể là giả mạo -- RẤT KHÓ XẢY RA (trừ khi đang đi máy bay ) -->
              // chỉ ra việc chuyển vị trí giả mạo (teleport) mà không thực tế, thường gặp ở các ứng dụng fake GPS.
              if (timeDiff > 0 && speed > 100) {
                updateLocationStatus(
                  false,
                  "Phát hiện thay đổi vị trí bất thường. Vui lòng không sử dụng GPS giả."
                );
                disableAttendanceButtons();
                return;
              }
            }

            // Lưu vị trí cho kiểm tra trong tương lai
            window.lastPosition = {
              coords: {
                latitude: coords.latitude,
                longitude: coords.longitude,
              },
              timestamp: position.timestamp,
            };

            // Gửi tọa độ đến server để xác thực
            fetch("/verify_location", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(coords),
            })
              .then((response) => response.json())
              .then((data) => {
                gpsVerified = data.verified;
                updateLocationStatus(data.verified, data.message);

                // Nếu không xác thực được, vô hiệu hóa chức năng điểm danh
                if (!data.verified) {
                  disableAttendanceButtons();
                }
              })
              .catch((error) => {
                console.error("Lỗi kết nối khi xác thực vị trí:", error);
                updateLocationStatus(false, "Lỗi kết nối khi xác thực vị trí.");
                disableAttendanceButtons();
              });
          },
          // Callback lỗi
          function (error) {
            let errorMessage = "Không thể xác định vị trí GPS.";
            switch (error.code) {
              case error.PERMISSION_DENIED:
                errorMessage =
                  "Bạn đã từ chối cấp quyền truy cập vị trí. Vui lòng cấp quyền và tải lại trang.";
                break;
              case error.POSITION_UNAVAILABLE:
                errorMessage = "Thông tin vị trí không khả dụng.";
                break;
              case error.TIMEOUT:
                errorMessage = "Quá thời gian yêu cầu vị trí.";
                break;
            }
            updateLocationStatus(false, errorMessage);
            disableAttendanceButtons();
          },
          // Tùy chọn
          {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 0,
          }
        );
      }

      // Thêm hàm tính khoảng cách ở phía client
      function calculateClientDistance(lat1, lon1, lat2, lon2) {
        const R = 6371000; // Bán kính trái đất tính bằng mét
        const dLat = deg2rad(lat2 - lat1);
        const dLon = deg2rad(lon2 - lon1);
        const a =
          Math.sin(dLat / 2) * Math.sin(dLat / 2) +
          Math.cos(deg2rad(lat1)) *
            Math.cos(deg2rad(lat2)) *
            Math.sin(dLon / 2) *
            Math.sin(dLon / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
        return R * c; // Khoảng cách tính bằng mét
      }

      function deg2rad(deg) {
        return deg * (Math.PI / 180);
      }

      // Hàm cập nhật hiển thị trạng thái vị trí
      function updateLocationStatus(verified, message) {
        const locationStatus = document.getElementById("locationStatus");
        if (locationStatus) {
          locationStatus.style.backgroundColor = verified
            ? "#d4edda"
            : "#f8d7da";
          locationStatus.style.color = verified ? "#155724" : "#721c24";
          locationStatus.innerHTML = `<strong>${
            verified ? "✓ " : "✗ "
          } ${message}</strong>`;
        }
      }

      // Hàm vô hiệu hóa nút điểm danh nếu xác thực vị trí thất bại
      function disableAttendanceButtons() {
        const cameraButtons = document.querySelectorAll(".icon-camera");
        cameraButtons.forEach((button) => {
          button.style.opacity = "0.5";
          button.style.cursor = "not-allowed";

          // Lưu trữ hàm onclick ban đầu
          button.dataset.originalOnclick = button.getAttribute("onclick");

          // Thay thế bằng hàm hiển thị lỗi
          button.setAttribute("onclick", "showLocationError()");
        });
      }

      // Hàm hiển thị lỗi vị trí khi cố gắng sử dụng nút đã bị vô hiệu hóa
      function showLocationError() {
        alert(
          "Bạn cần có mặt tại trường để thực hiện điểm danh. Vui lòng kiểm tra vị trí GPS của bạn."
        );
      }

      // Ghi đè hàm openCamera để kiểm tra xác thực GPS trước
      const originalOpenCamera = openCamera;
      openCamera = function (classId, date, element) {
        if (!gpsVerified) {
          alert(
            "Bạn cần có mặt tại trường để thực hiện điểm danh. Vui lòng kiểm tra vị trí GPS của bạn."
          );
          return;
        }

        // Gọi hàm gốc
        originalOpenCamera(classId, date, element);
      };

      function logoutValidation() {
        if (confirm("Bạn có chắc chắn muốn đăng xuất?")) {
          fetch("/logout_student", { method: "POST" })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                sessionStorage.removeItem("studentInfo");
                alert("Đăng xuất thành công!");
                window.location.href = "/login_student";
              }
            })
            .catch((error) => {
              console.error("Lỗi đăng xuất:", error);
            });
        }
      }

      // HÀM XỬ LÝ RESPONSE TỪ ĐIỂM DANH
      function handleAttendanceResponse(response) {
        const errorDiv = document.getElementById("validationError");
        const successDiv = document.getElementById("successMessage");

        // Ẩn tất cả thông báo trước
        if (errorDiv) errorDiv.style.display = "none";
        if (successDiv) successDiv.style.display = "none";

        if (response.success) {
          if (response.validation_passed) {
            if (successDiv) {
              successDiv.innerHTML = `
                          <strong> Điểm danh thành công!</strong><br>
                           Sinh viên: ${response.student_info.name} (${
                response.student_info.mssv
              })<br>
                           Thời gian: ${new Date().toLocaleString("vi-VN")}
                      `;
              successDiv.style.display = "block";

              // Tự động ẩn sau 5 giây
              setTimeout(() => {
                successDiv.style.display = "none";
              }, 5000);
            }
            alert(" Điểm danh thành công!");
          } else {
            if (errorDiv) {
              errorDiv.innerHTML = `
                          <strong> Điểm danh thất bại:</strong><br>
                          ${response.message}
                      `;
              errorDiv.style.display = "block";
            }
            alert(" Điểm danh thất bại!");
          }
        } else {
          if (response.validation_failed) {
            if (errorDiv) {
              errorDiv.innerHTML = `
                          <strong> CẢNH BÁO GIAN LẬN:</strong><br>
                          ${response.message.replace(/\n/g, "<br>")}<br>
                          <small><em>Hành vi này đã được ghi lại trong hệ thống.</em></small>
                      `;
              errorDiv.style.display = "block";
            }
            alert(" PHÁT HIỆN GIAN LẬN ĐIỂM DANH!\n\n" + response.message);
          } else if (response.redirect) {
            alert("Vui lòng đăng nhập trước khi điểm danh!");
            window.location.href = response.redirect;
          } else {
            if (errorDiv) {
              errorDiv.innerHTML = `
                          <strong> Lỗi hệ thống:</strong><br>
                          ${response.message}
                      `;
              errorDiv.style.display = "block";
            }
            alert(" Lỗi: " + response.message);
          }
        }
      }

      function updateAttendance(mssv, status, classId, date, element) {
        const formattedDate = new Date(date).toISOString().split("T")[0];
        fetch("/update_attendance", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            MSSV: mssv,
            status: status,
            class_id: classId,
            date: formattedDate,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              console.log("Attendance updated successfully");
              const row = element.closest("tr");
              const statusCell = row.cells[2];
              if (status === "Absent") {
                statusCell.innerHTML = '<i class="icon-cancel"></i>';
              } else {
                statusCell.innerHTML = '<i class="icon-tick"></i>';
              }
            } else {
              console.error("Error updating attendance");
            }
          });
      }

      const socket = io();

      // Gọi API cam python
      async function openCamera(classId, date, element) {
        try {
          // Kiểm tra session trước khi mở camera
          const sessionCheck = await fetch("/check_session");
          const sessionData = await sessionCheck.json();

          if (!sessionData.logged_in) {
            alert("Vui lòng đăng nhập trước khi điểm danh!");
            window.location.href = "/login_student";
            return;
          }

          // Mở webcam, chụp ảnh
          const video = document.createElement("video");
          video.autoplay = true;
          video.playsInline = true;
          video.style.position = "fixed";
          video.style.top = "50%";
          video.style.left = "50%";
          video.style.transform = "translate(-50%, -50%)";
          video.style.zIndex = 10000;
          video.style.background = "#000";
          video.width = 400;
          video.height = 300;
          document.body.appendChild(video);

          // Yêu cầu quyền truy cập webcam
          const stream = await navigator.mediaDevices.getUserMedia({
            video: true,
          });
          video.srcObject = stream;

          // Tạo nút chụp ảnh
          const captureBtn = document.createElement("button");
          captureBtn.innerText = " Chụp ảnh điểm danh";
          captureBtn.style.position = "fixed";
          captureBtn.style.top = "calc(50% + 180px)";
          captureBtn.style.left = "50%";
          captureBtn.style.transform = "translateX(-50%)";
          captureBtn.style.zIndex = 10001;
          captureBtn.style.background = "#28a745";
          captureBtn.style.color = "white";
          captureBtn.style.border = "none";
          captureBtn.style.padding = "10px 20px";
          captureBtn.style.borderRadius = "5px";
          captureBtn.style.fontSize = "16px";
          document.body.appendChild(captureBtn);

          // Tạo nút hủy
          const cancelBtn = document.createElement("button");
          cancelBtn.innerText = " Hủy";
          cancelBtn.style.position = "fixed";
          cancelBtn.style.top = "calc(50% + 220px)";
          cancelBtn.style.left = "50%";
          cancelBtn.style.transform = "translateX(-50%)";
          cancelBtn.style.zIndex = 10001;
          cancelBtn.style.background = "#dc3545";
          cancelBtn.style.color = "white";
          cancelBtn.style.border = "none";
          cancelBtn.style.padding = "8px 16px";
          cancelBtn.style.borderRadius = "5px";
          document.body.appendChild(cancelBtn);

          cancelBtn.onclick = function () {
            stream.getTracks().forEach((track) => track.stop());
            video.remove();
            captureBtn.remove();
            cancelBtn.remove();
          };

          captureBtn.onclick = async function () {
            try {
              // Chụp ảnh từ video
              const canvas = document.createElement("canvas");
              canvas.width = video.videoWidth || 400;
              canvas.height = video.videoHeight || 300;
              canvas
                .getContext("2d")
                .drawImage(video, 0, 0, canvas.width, canvas.height);
              const imageData = canvas.toDataURL("image/jpeg");

              // Dừng webcam
              stream.getTracks().forEach((track) => track.stop());
              video.remove();
              captureBtn.remove();
              cancelBtn.remove();

              // Hiển thị loading
              showNotification(" Đang xử lý điểm danh...");

              // Gửi ảnh qua API open_camera với validation
              const response = await fetch("/open_camera", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  classId,
                  date,
                  image: imageData,
                }),
              });

              const data = await response.json();

              // Xử lý response với validation
              handleAttendanceResponse(data);
            } catch (error) {
              console.error("Lỗi khi xử lý điểm danh:", error);
              alert("Lỗi khi xử lý điểm danh: " + error.message);
            }
          };
        } catch (error) {
          console.error("Lỗi khi mở camera:", error);
          alert("Không thể mở webcam: " + error.message);
        }
      }

      function showNotification(message) {
        const notification = document.createElement("div");
        notification.className = "notification";
        notification.innerText = message;
        notification.style.position = "fixed";
        notification.style.top = "20px";
        notification.style.right = "20px";
        notification.style.background = "#333";
        notification.style.color = "white";
        notification.style.padding = "10px 20px";
        notification.style.borderRadius = "5px";
        notification.style.zIndex = "10000";
        document.body.appendChild(notification);

        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 5000); // thời gian hiển thị 5 giây
      }

      // hiện tên và mssv
      const studentInfo = JSON.parse(sessionStorage.getItem("studentInfo"));
      console.log("student Info:", studentInfo); // Kiểm tra thông tin sinh viên

      if (studentInfo && studentInfo.student_id) {
        document.getElementById("studentName").innerText = studentInfo.name;
        document.getElementById("MSSV").innerText = studentInfo.student_id;
      } else {
        console.error(
          "Student ID is undefined or teacherInfo is not available."
        );
      }

      // đăng xuất
      document
        .getElementById("logout-button")
        .addEventListener("click", function () {
          sessionStorage.removeItem("studentInfo");
          window.location.href = "../";
        });

      // ngày
      document.addEventListener("DOMContentLoaded", function () {
        const dateInput = document.querySelector(".date-input");
        const btnPrev = document.querySelector(".btn_sd:first-child");
        const btnNext = document.querySelector(".btn_sd:last-child");

        // Khởi tạo ngày hiện tại
        const today = new Date();
        dateInput.value = formatDateForInput(today);

        // Cập nhật lịch khi vào trang
        updateSchedule(new Date(dateInput.value));

        // Gắn sự kiện cho nút "Trở về"
        btnPrev.addEventListener("click", function () {
          adjustWeek(-7); // Lùi 1 tuần
        });

        // Gắn sự kiện cho nút "Tiếp"
        btnNext.addEventListener("click", function () {
          adjustWeek(7); // Tăng 1 tuần
        });

        // Hàm điều chỉnh tuần
        function adjustWeek(days) {
          const currentDate = new Date(dateInput.value); // Ngày hiện tại trong input
          currentDate.setDate(currentDate.getDate() + days); // Điều chỉnh số ngày
          dateInput.value = formatDateForInput(currentDate); // Cập nhật giá trị input
          updateSchedule(currentDate); // Cập nhật bảng lịch
        }

        // Hàm định dạng ngày cho input (YYYY-MM-DD)
        function formatDateForInput(date) {
          const day = String(date.getDate()).padStart(2, "0");
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const year = date.getFullYear();
          return `${year}-${month}-${day}`;
        }

        dateInput.addEventListener("change", function () {
          const selectedDate = new Date(this.value);
          if (isNaN(selectedDate)) {
            console.error("Ngày không hợp lệ:", this.value);
            return;
          }
          updateSchedule(selectedDate);
        });

        // Hàm định dạng ngày cho bảng (DD-MM-YYYY)
        function formatDateForTable(date) {
          const day = String(date.getDate()).padStart(2, "0");
          const month = String(date.getMonth() + 1).padStart(2, "0");
          const year = date.getFullYear();
          return `${day}/${month}/${year}`;
        }

        function updateSchedule(baseDate) {
          if (isNaN(baseDate)) {
            console.error("Ngày không hợp lệ:", baseDate);
            return;
          }

          const dayOfWeek = baseDate.getDay(); // Lấy thứ (0: CN, 6: T7)
          const startOfWeek = new Date(baseDate);

          // Tính ngày Thứ 2 đầu tuần
          startOfWeek.setDate(
            baseDate.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)
          );

          const endOfWeek = new Date(startOfWeek);
          endOfWeek.setDate(startOfWeek.getDate() + 6);

          // Lấy các tiêu đề của bảng
          const headers = document.querySelectorAll(".schedule-table thead th");

          if (headers.length < 8) {
            console.error("Cấu trúc bảng lịch không đủ cột tiêu đề");
            return;
          }

          // Cập nhật nội dung các ô tiêu đề
          for (let i = 1; i <= 7; i++) {
            const currentDay = new Date(startOfWeek);
            currentDay.setDate(startOfWeek.getDate() + (i - 1));
            headers[i].innerHTML = `Thứ ${i + 1}<br>${formatDateForTable(
              currentDay
            )}`;
          }
          const scheduleTableBody = document.querySelector(
            ".schedule-table tbody"
          );
          scheduleTableBody.innerHTML = ""; // Xóa nội dung cũ

          console.log(studentInfo.student_id, startOfWeek, endOfWeek);
          // Gọi API để lấy lịch học, lịch thi
          fetch("/weekly_schedule", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              studentId: studentInfo.student_id,
              startDate: startOfWeek.toISOString().split("T")[0],
              endDate: endOfWeek.toISOString().split("T")[0],
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.success) {
                console.log("Lịch học:", data.schedule);

                // Lặp qua từng buổi (Sáng, Chiều, Tối)
                ["Sáng", "Chiều", "Tối"].forEach((period) => {
                  const row = document.createElement("tr");
                  row.innerHTML = `<td class="td_ca"><b>${period}</b></td>`;

                  // Lặp qua từng ngày trong tuần (Thứ 2 -> Chủ nhật)
                  for (let i = 0; i < 7; i++) {
                    const currentDay = new Date(startOfWeek);
                    currentDay.setDate(startOfWeek.getDate() + i);
                    const dayString = currentDay.toISOString().split("T")[0];

                    console.log("Ngày hiện tại:", dayString);

                    // Lấy dữ liệu theo ngày và buổi
                    const classes = data.schedule.filter(
                      (cls) => cls.date === dayString && cls.period === period
                    );

                    if (classes.length > 0) {
                      const classInfo = classes
                        .map(
                          (cls) => `
                            <div class="class-box">
                              <div>
                                <strong>${cls.name}</strong><br />
                                ${cls.classId}<br />
                                Tiết: ${cls.startPeriod} - ${
                            cls.endPeriod
                          }<br />
                                Giờ: ${cls.startTime} - ${cls.endTime}<br />
                                Phòng: ${cls.room}<br />
                                GV: ${cls.teacher}
                              </div>
                              ${
                                cls.status === "Absent"
                                  ? `<div class="icon-camera" onclick="openCamera('${cls.classId}', '${cls.date}', this)">
                                  <svg
                                    xmlns="http://www.w3.org/2000/svg"
                                    fill="none"
                                    viewBox="0 0 24 24"
                                    stroke-width="1.5"
                                    stroke="currentColor"
                                    class="size-6"
                                  >
                                    <path
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                      d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z"
                                    />
                                    <path
                                      stroke-linecap="round"
                                      stroke-linejoin="round"
                                      d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z"
                                    />
                                  </svg>
                                </div>`
                                  : `<div style="" class="icon-camera icon-tick"></div>`
                              }
                            </div>
                          `
                        )
                        .join("");
                      row.innerHTML += `<td>${classInfo}</td>`;
                    } else {
                      row.innerHTML += `<td></td>`;
                    }
                  }

                  scheduleTableBody.appendChild(row);
                });
              } else {
                console.error("Không thể lấy lịch học:", data.message);
              }
            })
            .catch((error) => {
              console.error("Lỗi khi lấy lịch học, lịch thi:", error);
            });
        }
      });
    </script>
  </body>
</html>
